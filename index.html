<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Remi Score Tracker</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; padding: 20px; text-align: center; }
  .box { max-width: 480px; margin: 0 auto 20px; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  input, button { font-size: 16px; padding: 8px 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
  button { cursor: pointer; background: #007bff; color: #fff; border: none; }
  button.secondary { background:#6c757d; }
  .players { text-align: left; }
  .playerRow { display:flex; justify-content:space-between; gap:8px; align-items:center; margin:6px 0; }
  .playerRow input[type="number"]{ width:110px; }
  .results, .history { margin-top: 12px; text-align:left; }
  .row { display:flex; justify-content:space-between; padding:6px 8px; background:#fafafa; border-radius:6px; margin-bottom:6px; }
  .small { font-size:13px; color:#666; }
</style>
</head>
<body>

<div class="box" id="setupBox">
  <h2>Remi Score Tracker</h2>
  <p>Unesite broj igrača (2-6):</p>
  <input type="number" id="numPlayers" min="2" max="6" placeholder="Broj igrača (2-6)">
  <button id="btnNext">Dalje</button>
</div>

<div class="box" id="gameBox" style="display:none;">
  <h3>Igra</h3>
  <div id="playersContainer" class="players"></div>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <button id="btnAddRound" style="flex:1">Dodaj bodove za rundu</button>
    <button id="btnFinish" class="secondary" style="flex:1">Završi igru</button>
  </div>

  <div class="results box" id="resultsBox" style="display:none;">
    <h4>Trenutni rezultati</h4>
    <div id="resultsList"></div>
  </div>

  <div class="history box" id="historyBox" style="display:none;">
    <h4>Istorija rundi</h4>
    <div id="historyList" class="small"></div>
  </div>
</div>

<script>
/* Key for localStorage */
const STORAGE_KEY = 'remiState_v1';

/* state structure:
{
  players: [{name: string, score: number, rounds: [numbers]}],
  dealerIndex: number
}
*/
let state = { players: [], dealerIndex: 0 };

/* --- load saved state from localStorage --- */
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (parsed && Array.isArray(parsed.players)) {
      state = parsed;
    }
  } catch(e) {
    console.error('loadState error', e);
  }
}

/* --- save to localStorage --- */
function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch(e) {
    console.error('saveState error', e);
  }
}

/* --- UI helpers --- */
const setupBox = document.getElementById('setupBox');
const gameBox = document.getElementById('gameBox');
const playersContainer = document.getElementById('playersContainer');
const resultsBox = document.getElementById('resultsBox');
const resultsList = document.getElementById('resultsList');
const historyBox = document.getElementById('historyBox');
const historyList = document.getElementById('historyList');

document.getElementById('btnNext').addEventListener('click', setupPlayersFromInput);
document.getElementById('btnAddRound').addEventListener('click', addRound);
document.getElementById('btnFinish').addEventListener('click', finishGame);

/* --- if saved state exists, restore UI --- */
loadState();
if (state.players && state.players.length > 0) {
  showGameUI();
  renderPlayersInputs();
  renderResults();
  renderHistory();
}

/* --- functions --- */
function setupPlayersFromInput(){
  const num = parseInt(document.getElementById('numPlayers').value);
  if (isNaN(num) || num < 2 || num > 6) {
    alert('Unesi broj igrača između 2 i 6.');
    return;
  }
  // ask names with prompt (keeps simple)
  state.players = [];
  state.dealerIndex = 0;
  for (let i=0;i<num;i++){
    const name = prompt(`Unesi ime igrača ${i+1}:`) || `Igrač ${i+1}`;
    state.players.push({ name: name, score: 0, rounds: [] });
  }
  saveState();
  showGameUI();
  renderPlayersInputs();
  renderResults();
  renderHistory();
}

function showGameUI(){
  setupBox.style.display = 'none';
  gameBox.style.display = 'block';
  resultsBox.style.display = 'block';
  historyBox.style.display = 'block';
}

function renderPlayersInputs(){
  playersContainer.innerHTML = '';
  state.players.forEach((p, i)=>{
    const div = document.createElement('div');
    div.className = 'playerRow';
    div.innerHTML = `
      <div style="flex:1"><strong>${p.name}</strong><div class="small">Dealer: ${i===state.dealerIndex? '✔':''}</div></div>
      <div><input type="number" id="input_score_${i}" placeholder="Bodovi"></div>
    `;
    playersContainer.appendChild(div);
  });
}

function addRound(){
  if (!state.players || state.players.length===0) { alert('Nema igrača.'); return; }
  const roundArr = [];
  for (let i=0;i<state.players.length;i++){
    const input = document.getElementById(`input_score_${i}`);
    const v = input ? parseInt(input.value) : NaN;
    const pts = (!isNaN(v) ? v : 0);
    state.players[i].score += pts;
    state.players[i].rounds.push(pts);
    roundArr.push(pts);
    if (input) input.value = '';
  }
  // rotate dealer
  state.dealerIndex = (state.dealerIndex + 1) % state.players.length;
  saveState();
  renderPlayersInputs();
  renderResults();
  renderHistory();
  // small feedback
  window.navigator.vibrate?.(50);
}

function renderResults(){
  resultsList.innerHTML = '';
  // sort: lowest score (biggest minus) first = best
  const sorted = state.players.map((p,i)=>({name:p.name, score:p.score})).sort((a,b)=>a.score - b.score);
  sorted.forEach(s=>{
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `<div>${s.name}</div><div><strong>${s.score}</strong></div>`;
    resultsList.appendChild(row);
  });
}

function renderHistory(){
  historyList.innerHTML = '';
  if (!state.players || state.players.length===0) return;
  // show rounds with index and players' round scores
  state.players[0].rounds.forEach((_, roundIndex)=>{
    const items = state.players.map((p,i)=>`${p.name}: ${p.rounds[roundIndex]||0}`);
    const div = document.createElement('div');
    div.className = 'small';
    div.style.marginBottom = '6px';
    div.textContent = `Runda ${roundIndex+1}: ${items.join(' | ')}`;
    historyList.appendChild(div);
  });
}

/* finishGame: save history to temporary view then clear stored state (auto-delete) */
function finishGame(){
  if (!state.players || state.players.length===0) return;
  if (!confirm('Završiti igru? Svi podaci ove partije će biti izbrisani iz memorije.')) return;

  // show final summary in an alert or new window — here prikazemo kratko modal-like
  let summary = 'Konačni rezultati:\n';
  const sorted = state.players.map(p=>({name:p.name,score:p.score})).sort((a,b)=>a.score - b.score);
  sorted.forEach(s => summary += `${s.name}: ${s.score}\n`);
  alert(summary);

  // clear saved state (automatic delete)
  localStorage.removeItem(STORAGE_KEY);
  // reset in-memory
  state = { players: [], dealerIndex: 0 };
  // reset UI
  playersContainer.innerHTML = '';
  resultsList.innerHTML = '';
  historyList.innerHTML = '';
  gameBox.style.display = 'none';
  setupBox.style.display = 'block';
  document.getElementById('numPlayers').value = '';
}

/* ensure state saved when page is about to unload (safety) */
window.addEventListener('beforeunload', () => {
  // save only if players exist
  if (state.players && state.players.length>0) saveState();
});
</script>

</body>
</html>
